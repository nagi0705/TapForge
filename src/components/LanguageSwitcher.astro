---
import { languages, type Language } from "../lib/i18n";

interface Props {
  currentLang?: Language;
}

// Get current language from URL path
const pathname = Astro.url.pathname;
let detectedLang: Language = "ja";

// Detect language from URL path
if (pathname.startsWith('/en/') || pathname === '/en') {
  detectedLang = "en";
} else if (pathname.startsWith('/zh/') || pathname === '/zh') {
  detectedLang = "zh";
} else if (pathname.startsWith('/ko/') || pathname === '/ko') {
  detectedLang = "ko";
} else if (pathname.startsWith('/es/') || pathname === '/es') {
  detectedLang = "es";
}

const { currentLang = detectedLang } = Astro.props;

// Function to get the language-switched path
function getLanguageSwitchedPath(targetLang: string, currentPath: string): string {
  // Remove any existing language prefix
  let basePath = currentPath;

  // Remove language prefix if present
  if (currentPath.match(/^\/(en|zh|ko|es)(\/|$)/)) {
    basePath = currentPath.replace(/^\/(en|zh|ko|es)(\/|$)/, '/');
  }

  // For now, always redirect to the index page of the target language
  // because we only have language-specific index pages
  if (targetLang === "ja") {
    return "/";
  } else {
    return `/${targetLang}/`;
  }
}
---

<style>
  .language-switcher {
    position: relative;
  }
  
  .language-switcher:hover .language-menu {
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  .language-switcher:hover .dropdown-arrow {
    transform: rotate(180deg);
  }
  
  .language-menu {
    transition: all 0.2s ease-in-out;
  }
  
  .dropdown-arrow {
    transition: transform 0.2s ease-in-out;
  }
</style>

<div class="language-switcher relative inline-block text-left">
  <div>
    <button
      type="button"
      class="inline-flex items-center justify-center gap-x-1 rounded-lg bg-white px-1 py-1 text-xs font-semibold text-gray-900 shadow-sm border border-gray-200 hover:bg-gray-50 transition-colors duration-200 min-w-[60px] max-w-[80px] cursor-pointer md:px-1 md:text-xs md:min-w-[70px] md:max-w-[90px]"
      id="language-menu-button"
      aria-expanded="false"
      aria-haspopup="true"
    >
      <!-- åœ°çƒå„€ã‚¢ã‚¤ã‚³ãƒ³ -->
      <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.523-1.943A5.977 5.977 0 0116 10c0 .34-.028.675-.083 1H15a2 2 0 00-2 2v2.197A5.973 5.973 0 0110 16v-2a2 2 0 00-2-2 2 2 0 01-2-2 2 2 0 00-1.668-1.973z" clip-rule="evenodd"></path>
      </svg>
      
      <!-- è¨€èªžãƒ†ã‚­ã‚¹ãƒˆ -->
      <span class="text-gray-700 font-medium" id="current-language-text">
        {languages[currentLang]}
      </span>
      
      <!-- ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³çŸ¢å° -->
      <svg
        class="dropdown-arrow w-3 h-3 text-gray-400"
        id="dropdown-arrow"
        viewBox="0 0 20 20"
        fill="currentColor"
        aria-hidden="true"
      >
        <path
          fill-rule="evenodd"
          d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
          clip-rule="evenodd"></path>
      </svg>
    </button>
  </div>

  <div
    class="language-menu absolute right-0 z-10 mt-2 w-48 origin-top-right rounded-lg bg-white shadow-lg border border-gray-200 focus:outline-none opacity-0 invisible"
    id="language-menu"
    role="menu"
    aria-orientation="vertical"
    tabindex="-1"
  >
    <div class="py-2" role="none">
      {
        Object.entries(languages).map(([code, name]) => {
          const href = getLanguageSwitchedPath(code, pathname);
          return (
            <a
              href={href}
              class={`flex items-center px-4 py-3 text-sm transition-colors duration-150 ${
                code === currentLang
                  ? "bg-blue-50 text-blue-700 border-r-2 border-blue-500"
                  : "text-gray-700 hover:bg-gray-50"
              }`}
              role="menuitem"
              tabindex="-1"
            >
            <!-- å›½æ——ã‚¢ã‚¤ã‚³ãƒ³ -->
            <span class="mr-3 text-lg">
              {code === "ja" && "ðŸ‡¯ðŸ‡µ"}
              {code === "en" && "ðŸ‡ºðŸ‡¸"}
              {code === "zh" && "ðŸ‡¨ðŸ‡³"}
              {code === "ko" && "ðŸ‡°ðŸ‡·"}
              {code === "es" && "ðŸ‡ªðŸ‡¸"}
            </span>
            <!-- è¨€èªžå -->
            <span class="font-medium">{name}</span>
          </a>
          );
        })
      }
    </div>
  </div>
</div>

<script>
  // Simple and reliable language switcher
  function initLanguageSwitcher() {
    const button = document.getElementById("language-menu-button");
    const menu = document.getElementById("language-menu");
    const arrow = document.getElementById("dropdown-arrow");

    if (!button || !menu || !arrow) {
      return;
    }

    // Button click handler
    button.addEventListener("click", function(e) {
      e.preventDefault();
      e.stopPropagation();
      toggleLanguageMenu();
    });

    // Close menu when clicking outside
    document.addEventListener("click", function(e) {
      if (!button.contains(e.target) && !menu.contains(e.target)) {
        menu.classList.remove("opacity-100", "visible");
        menu.classList.add("opacity-0", "invisible");
        arrow.classList.remove("rotate-180");
        button.setAttribute("aria-expanded", "false");
      }
    });

    // Close menu when pressing Escape
    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape") {
        menu.classList.remove("opacity-100", "visible");
        menu.classList.add("opacity-0", "invisible");
        arrow.classList.remove("rotate-180");
        button.setAttribute("aria-expanded", "false");
      }
    });
  }

  // Toggle language menu
  function toggleLanguageMenu() {
    const button = document.getElementById("language-menu-button");
    const menu = document.getElementById("language-menu");
    const arrow = document.getElementById("dropdown-arrow");

    if (!button || !menu || !arrow) {
      return;
    }

    const isOpen = menu.classList.contains("opacity-100");
    
    if (isOpen) {
      // Close menu
      menu.classList.remove("opacity-100", "visible");
      menu.classList.add("opacity-0", "invisible");
      arrow.classList.remove("rotate-180");
      button.setAttribute("aria-expanded", "false");
    } else {
      // Open menu
      menu.classList.remove("opacity-0", "invisible");
      menu.classList.add("opacity-100", "visible");
      arrow.classList.add("rotate-180");
      button.setAttribute("aria-expanded", "true");
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initLanguageSwitcher);
  } else {
    initLanguageSwitcher();
  }
</script>
